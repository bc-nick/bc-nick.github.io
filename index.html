<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Checkout sdk headless store</title>

    <script src="index.js"></script>
</head>
<body>
    <div>
        <h1>Input data</h1>
        <div style="padding-bottom: 20px">
            <label for="env-select">Environment:</label>
            <br/>
            <select name="env" id="env-select">
                <option value="local" selected="selected">Local</option>
                <option value="int">Integration</option>
                <option value="prod">Production</option>
            </select>
        </div>
        <div style="padding-bottom: 20px">
            <label for="bc-store-url">Storefront Host Url (example: https://my-dev-store-165941143.store.bcdev/): </label>
            <br/>
            <input
                id="bc-store-url"
                type="text"
                value="https://my-dev-store-165941143.store.bcdev"
                style="width: 700px"
            />
        </div>

        <div>
            <input id="graphql-checkbox" type="checkbox" />
            <label for="graphql-checkbox">Use GraphQL data</label>
        </div>

        <button id="render-paypal-button">Render PayPal Button</button>

        <div style="margin-top: 40px">Here should be a paypal button:</div>
        <div id="paypalcommerce-button"></div>

        <script async>
            function getBcStoreUrl() {
                return document.getElementById('bc-store-url').value;
            }

            async function fetchPaymentWalletButtons() {
                const bcStoreUrl = getBcStoreUrl();
                const billingAddressCountry = 'US';

                const graphQLUrl = `${bcStoreUrl}/graphql`;
                const graphQLQuery = `
                    query {
                        site {
                            paymentWallets(billingCountry: ${billingAddressCountry}) {
                                edges {
                                    node {
                                        paymentMethodId
                                    }
                                }
                            }
                        }
                    }
                `;

                try {
                    const response = await fetch(graphQLUrl, {
                        method: "POST",
                        headers: {
                            'Content-Type': 'application/json',

                        },
                        body: JSON.stringify(graphQLQuery),
                    });

                    console.log(response.body);

                    return response.body.data.paymentWallets.edges.map(paymentWalletEdge => {
                        return paymentWalletEdge.node.paymentMethodId;
                    });
                } catch(error) {
                    console.error(error);

                    return {};
                }
            }

            function getWalletButtonsOption(paymentMethodId) {
                switch (paymentMethodId) {
                    case 'paypalcommerce.paypal': {
                        return {
                            paymentMethodId: 'paypalcommerce.paypal',
                            containerId: 'paypalcommerce-button',
                            options: {
                                style: {"color":"gold","label":"checkout"},
                                // TODO: When PayNow is enabled
                                // onComplete: () => {
                                //     const url = '/checkout/order-confirmation';
                                //     location.replace(url);
                                //     return new Promise();
                                // },
                            },
                        };
                    }
                    default:
                        return {};
                }
            }

            async function onRenderPayPalButtonClick() {
                const bcStoreUrl = getBcStoreUrl();
                const env = document.getElementById('env-select').value;
                const isGqlEnabled = document.getElementById('graphql-checkbox').checked;

                // TODO: disable button when loading
                // const button = document.getElementById('render-paypal-button');

                if (!bcStoreUrl) {
                    console.error('Can\'t render PayPal button because bc store url is not provided');

                    return;
                }

                const mockedPaymentWalletsList = ['paypalcommerce.paypal'];

                const paymentWalletsList = isGqlEnabled ? await fetchPaymentWalletButtons() : mockedPaymentWalletsList;
                const walletButtonsOptions = paymentWalletsList.map(getWalletButtonsOption);

                console.log({ bcStoreUrl, env, paymentWalletsList, walletButtonsOptions });

                await window.BigCommerce.renderWalletButtons({
                    bcStoreUrl,
                    env,
                    walletButtons: walletButtonsOptions,
                });
            }

            const button = document.getElementById('render-paypal-button');
            button.addEventListener('click', onRenderPayPalButtonClick);
        </script>
    </div>
</body>
</html>
